<!DOCTYPE html>
<html>
<head>
	  <link rel="stylesheet" type="text/css" href="index.css">
  	  <script src="/scripts/jquery-1.10.2.min.js" type="text/javascript"></script>
  	  <script src="/scripts/jquery.signalR-2.2.0.min.js" type="text/javascript"></script>
</head>
<body>
<a id="mybids" href="">my bids</a>
Hello

<script>
    var htmlServerUrl = 'http://localhost:8200';
    var signalrServerUrl = 'http://localhost:8100';
    var signalrHubName = 'bidsHub';
	var signalrConnectionTimer;
	var bidIdPrefix = 'bid_';
	var mybidsLinkId = 'mybids';
	function startSignalrConnectionTimer()
	{
	    return setInterval(function()
			 {
				console.log("tick");
				connection.start().done(function()
                {
                  console.log('Now connected, connection ID=' + connection.id);
                }).fail(function()
				{
				  console.log('Could not connect');
				});
			 }, 5000);
	}

	$(document).ready(function()
	{
     	$('#' + mybidsLinkId).click(function()
		{
           console.log('clicked');
    	   var win = window.open(htmlServerUrl + '/mybids.html', '_blank');
            if(win){
                //Browser has allowed it to be opened
                win.focus();
            }else{
                //Broswer has blocked it
                alert('Please allow popups for this site');
            }
		});
	});

</script>

<script>
  		         var connection = $.hubConnection(signalrServerUrl + '/signalr');
		   		 connection.stateChanged(function (change)
				 {
				    switch (change.newState)
					{
						   case $.signalR.connectionState.connecting:   console.log('Connecting');
						                                                break;
						   case $.signalR.connectionState.connected:    {
						   												   console.log('Connected');
																		   clearTimeout(signalrConnectionTimer);
						   												   hubProxy.invoke('GetAllBids');
						                                                }
																		break;
					 	   case $.signalR.connectionState.reconnecting: console.log('Re-connecting');
						                                                break;
						   case $.signalR.connectionState.disconnected: {
						   												  clearTimeout(signalrConnectionTimer);
						   												  signalrConnectionTimer = startSignalrConnectionTimer();
						                                                  console.log('Disconnected');
						                                                }
																		break;
						   default: break;
					}
                });

				 var hubProxy = connection.createHubProxy(signalrHubName);
				 if (hubProxy !== undefined)
				 {
				    alert("Hub ok");
				 	hubProxy.on('jsAddBids', function(bids)
					{
					     addDisplayedBids(bids)
					});

					hubProxy.on('jsAddBid', function(bid)
					{
					 	 addDisplayedBid(bid);
					});

					hubProxy.on('jsRemoveBid', function(bidId)
					{
					     removeDisplayedBid(bidId);
					});

					hubProxy.on('jsUpdateBid', function(bidId)
					{

					});
				 }
				 signalrConnectionTimer = startSignalrConnectionTimer();
</script>

<script>
	function removeAllDisplayedBids()
	{
		$('.bidDiv').remove();
	}

	function addDisplayedBids(bids)
	{
    	for (var i = 0; i < bids.length; i++)
        {
             var bid = bids[i];
    	 	 addDisplayedBid(bid);
    	}
	}

	function addDisplayedBid(bid)
	{
	    $('body').append('<div class="bidDiv" id=' + bidIdPrefix + bid.id + '>' + bid.poster + ' ' + bid.operationType + ' ' + bid.currency + ' ' + bid.amount + ' ' + bid.price + '</div>');
	}

	function modifyDisplayedBid(bidJson)
	{
	 	bidIdsSet = getDisplayedBidIds();
		if (bidIdsSet.has(bidJson.id))
		{
		   $("#" + bidIdPrefix + bidJson.id).html(bidJson.applicant + ' ' + bidJson.amount);
		   alert($("#" + bidIdPrefix + bidJson.id).html());
		}
	}

	function removeDisplayedBid(bidId)
	{
	    bidId = bidId + "";
	 	bidIdsSet = getDisplayedBidIds();
		if (bidIdsSet.has(bidId))
		{
		    $("#" + bidIdPrefix + bidId).remove();
		}
	}

	function getDisplayedBidIds()
	{
		var bidSet = new Set();
		var bidDivs = $(".bidDiv").each(function(i)
		{
		 	bidId = getDisplayedBidId($(this));
			bidSet.add(bidId);
		});
		return bidSet;
	}

	function getDisplayedBidId(bidDivJquery)
	{
	 	var bidId = bidDivJquery.attr('id').substring(bidIdPrefix.length, bidDivJquery.attr('id').length);
		return bidId;
	}

</script>

</body>
</html>
